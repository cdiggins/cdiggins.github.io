<!DOCTYPE html>
<html lang="en">
  <head>
  </head>

  <body>
    <!-- Fixed navbar -->
    <nav class="navbar navbar-inverse navbar-fixed-top">
      <div class="container">
        <div class="navbar-header">
          <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false" aria-controls="navbar">
            <span class="sr-only">Toggle navigation</span>
            <span class="icon-bar"></span>
            <span class="icon-bar"></span>
            <span class="icon-bar"></span>
          </button>
          <a class="navbar-brand" href="#">Christopher Diggins</a>
        </div>
        <div id="navbar" class="navbar-collapse collapse">
          <ul class="nav navbar-nav">
            <li><a href="../index.html">Home</a></li>
            <li><a href="../blog.html">Blog</a></li>
            <li><a href="../about.html">About</a></li>
            <li><a href="myna-blog-maker.html">Previous</a></li>
            <li><a href="">Next</a></li>
          </ul>
        </div><!--/.nav-collapse -->
      </div>
    </nav>

    <div class="container" role="main">
    
        <div class="theme-showcase col-sm-8" id='content'>
          <p>
            <h1>For Loops are Functional </h1>
        <p>
          <h4>Sunday, July 23, 2017</h4>
          <h5><a href='myna-blog-maker.html'><< A Static Blog Generator in Myna</a></h5>
        </p>

<p>It has been known for quite some time within the functional programming community, that many programming constructs widely considered to be "imperative" in nature (e.g. goto statements, for loops, while loops, etc.) can be expressed in terms of function calls without side-effects. </p>

<p>I was explaining to someone the other day how programmers can write code that looks imperative, for example using a Python syntax, and that it can be transformed by a compiler into pure functional code. </p>

<p>In this article I will start from a simple Python example and demonstrate a series of simple transformations that could be done by a compiler to convert a traditional <code>for</code> loop into a pure function call. </p>

<p>These transformations do not remove all side-effects, only assignment to variables within the current stack frame.</p>

<h2>Summing Numbers from the Fibonnaci Sequence</h2>

<p>The working example sums five numbers in the Fibonnaci sequence using a <code>for</code> loop. </p>

<pre>    acc = 0
    for x in [1, 2, 3, 5, 8]:
        acc += x
    print acc
</pre>

<h2>Rewriting as a For Loop with an Index</h2>

<p>In the first transformation we rewrite the <code>for</code> loop to use an explicit integer index, and we assign the array to a named variable. This makes it look more like a C-style for loop. It should also make it more obvious how the transformations can be generalized to arbitrary variable assignment on the stack. </p>

<pre>    acc = 0
    xs = [1, 2, 3, 5, 8]
    n = len(xs)
    for i in range(n):
        acc += xs[i]
    print acc
</pre>

<h2>Convert the For Loop into a While Loop</h2>

<p>The <code>for</code> loop can be understood as syntactic sugar (i.e. a convenient syntax) for a <code>while</code> loop. So the first transformation is into a <code>while</code> loop. </p>

<pre>    acc = 0
    xs = [1, 2, 3, 5, 8]
    n = len(xs)
    i = 0
    while i < n:
        acc += xs[i]
        i++
    print acc
</pre>

<h2>Stack Frame to Tuple</h2>

<p>All of the variables in the stack frame referenced from within the loop are next merged into a single tuple. This is the key observation in making local variable updates into something that can be expressed purely in terms of functional calls. </p>

<pre>    f = { 5, [1,2,3,5,8], 0, 0 }
    while (f.i < f.n) 
        f = { f[0], f[1], f[2] + f[2][f[3]], f[3]+1 } 
    print acc;
</pre>

<h2>Replace While loop with a While Function</h2>

<p>Now presuming the presence of a <code>while_fxn</code> we can convert the while statement into a single function call.</p>

<pre>    f = while_fxn({ 5, [1,2,3,5,8], 0, 0 }, 
        lambda f: { f[0], f[1], f[2] + f[2][f[3]], f[3]+1 },
        lambda f: f.i < f.n)
    print f[2];
</pre>

<p>Here is one possible implementation of the <code>while</code> function using the original <code>while</code> statement, which we can imagine being implemented by the compiler.</p>

<pre>   def while_fxn(x, bodyFxn, terminationFxn):
       while (!termination(x)):
            x = body(x)
       return x
</pre>

<h2>A Tail-Recursive While Function</h2>

<p>It is also interesting to note that the compiler can omit support for a <code>while</code> function primitive construct if we implement it as follows: </p>

<pre>   def while_fxn(x, bodyFxn, conditionFxn):
       return !condition(x) ? x : body(x)
</pre>

<p>A problem with this approach if literally implementing it, is that the compiler/interpreter needs to support <a href = "https://en.wikipedia.org/wiki/Tail_call">tail-call optimization (TCO)</a> to prevent stack-overflow when executed more than a few times. </p>

<h2>Summary</h2>

<p>The point of this article was to show how code with what looked like imperative code can be converted into pure functionally called through a series of transformations which could be performed by a compiler or interpreter. The key observation is that the reference variables of the stack frame can be modeled as a "tuple".</p>

<p>This technique can be useful when converting from imperative code to data-flow code, which is something I'll discuss in a later blog post. </p>

<h2>Postscript: Using Itertools.Accumulate</h2>

<p>A Python expert could argue that the example could have been rewritten using the <a href = "https://docs.python.org/3/library/itertools.html"><code>itertools.accumulate</code></a> function.</p>

<pre>    import itertools as it;
    print it.accumulate([1,2,3,5,8])
</pre>

<p>This is true for a programmer, since they can easily identify that the loop in this case is effectively only varying a single value using the binary operation of addition. However, IMO this is not easily expressed as a single transform for a compiler, and does not generalize to arbitrary sets of variable assignments. I wanted to show how the compiler can progressively rewrite imperative code until it gets to something that can be expressed in terms of function calls. </p>

<p>Consider a more complex example like <a href = "https://github.com/ricardojmendez/LibNoise.Unity/blob/master/Generator/RidgedMultifractal.cs#L132">Ridged multi-fractal noise</a>, for which the same techniques shown in the article can be applied. </p>

<h2>References </h2>

<p>A paper widely referenced on the correspondance between imperative structures and functional programming is <i>"Lambda the Ultimate Imperative"</i> by Guy Steele and Gerald Sussman 1976. You can <a href = "http://library.readscheme.org/page1.html">find that article here</a> along with other papers related on the subject.The <a href = "https://en.wikipedia.org/wiki/Tail_call">Wikipedia article on tail recursion</a> also currently provides a good overview of the subject. </p>


          </p>
        </div>
    <div class="col-sm-4 sidebar-module sidebar-module-inset">
                
        <h3>About Me</h3>
        <!--
        <p>
          I have been programming computers for over 30 years and I am 
          still fascinated by software development and computer science,
          particularly in the areas of programming languages and 3D graphics.  
        </p>
        <p>
          I use the blog to share what my ideas and discoveries with others, as it helps 
          me better understand what we are all doing.
          <a href="about.html">See here</a> to learn more about me and this blog,
          or to reach out to me.
        </p>
        -->
        <h3>Recent Posts</h3>
        <ul>          
              <li><a href="for-loops-are-functional.html">For Loops are Functional Too</a>
              <!-- <br/><div class="sidebar-date">Sunday, July 23, 2017</div></li> -->
            
              <li><a href="blog/myna-blog-maker.html">A Static Blog Generator in Myna</a>
              
              <!-- <br/><div class="sidebar-date">Tuesday, July 11, 2017</div></li> -->
            
              <li><a href="blog/myna-parsing-library.html">The Myna parsing library for JavaScript</a>
              
              <!-- <br/><div class="sidebar-date">Tuesday, July 11, 2017</div></li> -->
            
              <li><a href="blog/first.html">First post!</a><br/>
              
              <!-- <div class="sidebar-date">Monday, July 10, 2017</div></li> -->
        </ul>

        <a href="blog.html">More posts ...</a>

        <h3>Share this Post</h3>
          <ul class="fa-ul">
            <li><i class="fa fa-facebook fa-fw" aria-hidden="true"></i>&nbsp;<a href="#">Facebook</a></li>
            <li><i class="fa fa-twitter fa-fw" aria-hidden="true"></i>&nbsp;<a href="#">Twitter</a></li>
            <li><i class="fa fa-reddit fa-fw" aria-hidden="true"></i>&nbsp;<a href="#">Reddit</a></li>
            <li><i class="fa fa-google-plus fa-fw" aria-hidden="true"></i>&nbsp;<a href="#">Google+</a></li>
            <li><i class="fa fa-linkedin fa-fw" aria-hidden="true"></i>&nbsp;<a href="#">LinkedIn</a></li>
          </ul>
        </p>

    </div>
    </div>
		    
 <!-- Footer -->
<hr>
<footer style='text-align:center'>
  <div class="container">
  <div class="row">
    <a href="mailto:cdiggins@gmail.com" title="Email me">
      <span class="fa-stack fa-lg">
        <i class="fa fa-circle fa-stack-2x"></i>
        <i class="fa fa-envelope fa-stack-1x fa-inverse"></i>
      </span>
    </a>
    <a href="https://www.facebook.com/diggins.software" title="Facebook">
      <span class="fa-stack fa-lg">
        <i class="fa fa-circle fa-stack-2x"></i>
        <i class="fa fa-facebook fa-stack-1x fa-inverse"></i>
      </span>
    </a>
    <a href="https://github.com/cdiggins" title="GitHub">
      <span class="fa-stack fa-lg">
        <i class="fa fa-circle fa-stack-2x"></i>
        <i class="fa fa-github fa-stack-1x fa-inverse"></i>
      </span>
    </a>
    <a href="https://twitter.com/cdiggins" title="Twitter">
      <span class="fa-stack fa-lg">
        <i class="fa fa-circle fa-stack-2x"></i>
        <i class="fa fa-twitter fa-stack-1x fa-inverse"></i>
      </span>
    </a>
    <a href="https://linkedin.com/in/cdiggins" title="LinkedIn">
      <span class="fa-stack fa-lg">
        <i class="fa fa-circle fa-stack-2x"></i>
        <i class="fa fa-linkedin fa-stack-1x fa-inverse"></i>
      </span>
    </a>
    <!--
    <a href="https://stackoverflow.com/users/184528/cdiggins" title="StackOverflow">
      <span class="fa-stack fa-lg">
        <i class="fa fa-circle fa-stack-2x"></i>
        <i class="fa fa-stack-overflow fa-stack-1x fa-inverse"></i>
      </span>
    </a>
    -->
    <!--
    <a href="https://www.youtube.com/user/cdiggins" title="Youtube">
      <span class="fa-stack fa-lg">
        <i class="fa fa-circle fa-stack-2x"></i>
        <i class="fa fa-youtube fa-stack-1x fa-inverse"></i>
      </span>
    </a>
    -->                        
    <a href="https://cdiggins.github.io/rss.xml" title="RSS">
      <span class="fa-stack fa-lg">
        <i class="fa fa-circle fa-stack-2x"></i>
        <i class="fa fa-rss fa-stack-1x fa-inverse"></i>
      </span>
    </a>
  <p class="copyright text-muted">Copyright &copy; Christopher Diggins 2017</p>
  </div>
  </div>
  </footer>
		    <script>
    (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
    (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
    m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
    })(window,document,'script','https://www.google-analytics.com/analytics.js','ga');
    ga('create', 'UA-93495883-1', 'auto');
    ga('send', 'pageview');
    </script>
		    
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/1.12.4/jquery.min.js"></script>
    <script src="https://cdiggins.github.io/dist/js/bootstrap.min.js"></script>
    <script src="https://cdiggins.github.io/assets/js/docs.min.js"></script>
    <script src="https://cdiggins.github.io/assets/js/ie10-viewport-bug-workaround.js"></script>
  </body>
</html>

